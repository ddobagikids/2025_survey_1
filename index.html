<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>또바기 어린이집 조합원 설문조사</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 기본 스타일 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #5fa031 0%, #4a7c23 100%);
            min-height: 100vh;
            color: white;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        /* 비밀번호 입력 화면 */
        .password-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #5fa031 0%, #4a7c23 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .password-container {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
        }
        
        .password-logo {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 2rem;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            background-image: url('/assets/logo.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* 로고 이미지가 없을 때 또 글자 숨김 */
        .password-logo:empty {
            /* 글자 표시 안함 */
        }
        
        .password-title {
            color: white;
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .password-subtitle {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 2rem;
            font-size: 1rem;
        }
        
        .password-input,
        .password-button {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            box-sizing: border-box;
        }
        
        .password-input {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .password-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .password-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
        }
        
        .password-button {
            background: rgba(255, 255, 255, 0.9);
            color: #4a7c23;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .password-button:hover {
            background: white;
            transform: translateY(-2px);
        }
        
        .password-error {
            color: #fca5a5;
            margin-top: 1rem;
            font-size: 0.9rem;
            display: none;
        }
        
        .main-content {
            display: none;
        }
        
        .main-content.unlocked {
            display: block;
        }
        
        .password-screen.hidden {
            display: none;
        }

        /* 헤더 */
        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 2rem;
            font-size: 2rem;
            font-weight: bold;
            background-image: url('/assets/logo.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* 로고 이미지가 없을 때 또 글자 숨김 */
        .logo:empty {
            /* 글자 표시 안함 */
        }

        .title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 2rem;
        }

        /* 통계 카드 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 3rem;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            opacity: 1;
            font-size: 0.9rem;
        }

        /* 섹션 카드 */
        .section-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .section-card:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 2rem;
            cursor: pointer;
        }

        .section-title-area {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .section-icon {
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
        }

        .section-number {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 0.25rem;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .section-content {
            padding: 0 2rem 2rem;
            display: none;
        }

        .section-content.active {
            display: block;
        }

        .chevron {
            font-size: 1.5rem;
            transition: transform 0.3s ease;
        }

        .chevron.rotated {
            transform: rotate(180deg);
        }

        /* 차트 컨테이너 */
        .chart-container {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .chart-wrapper {
            position: relative;
            height: 500px;
            margin-bottom: 1rem;
        }

        /* 만족도 점수 표시 */
        .satisfaction-score {
            text-align: center;
            padding: 3rem 2rem;
        }

        .score-display {
            font-size: 4rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #fff;
        }

        .score-label {
            font-size: 1.2rem;
            opacity: 0.8;
            margin-bottom: 2rem;
        }

        /* 서술형 응답 */
        .narrative-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .narrative-section {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 2rem;
        }

        .narrative-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quote-card {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: background 0.2s ease;
        }

        .quote-card:hover {
            background: rgba(255, 255, 255, 0.6);
        }

        .quote-text {
            font-style: italic;
            line-height: 1.6;
            color: rgba(74, 124, 35, 0.8);
            font-weight: bold;
        }

        .quote-text:before {
            content: '"';
            font-size: 1.2em;
            color: rgba(74, 124, 35, 0.8);
        }

        .quote-text:after {
            content: '"';
            font-size: 1.2em;
            color: rgba(74, 124, 35, 0.8);
        }



        /* 통합 섹션 스타일 */
        .combined-section {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .chart-and-narrative {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .stat-card {
                padding: 1.5rem;
            }
            
            .stat-value {
                font-size: 2rem;
            }
            
            .section-header {
                padding: 1.5rem;
            }
            
            .section-title {
                font-size: 1.1rem;
            }
            
            .chart-wrapper {
                height: 400px;
            }
            
            .narrative-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-and-narrative {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0.5rem;
            }
            
            .title {
                font-size: 1.5rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .stat-card {
                padding: 1rem;
            }
            
            .stat-value {
                font-size: 1.8rem;
            }
            
            .stat-icon {
                font-size: 2rem;
                margin-bottom: 0.5rem;
            }
            
            .section-header {
                padding: 1rem;
            }
            
            .section-content {
                padding: 0 1rem 1rem;
            }
            
            .chart-wrapper {
                height: 350px;
            }

            .score-display {
                font-size: 3rem;
            }
        }

        /* 플로팅 네비게이션 */
        .floating-nav {
            position: fixed;
            right: 2rem;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
            min-width: 200px;
        }

        .floating-nav h4 {
            color: white;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            text-align: center;
            opacity: 0.9;
        }

        .nav-item {
            display: block;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.25rem;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        /* 모바일에서 플로팅 네비게이션 숨김 */
        @media (max-width: 768px) {
            .floating-nav {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- 비밀번호 입력 화면 -->
    <div class="password-screen" id="passwordScreen">
        <div class="password-container">
            <div class="password-logo"></div>
            <h1 class="password-title">또바기 어린이집</h1>
            <p class="password-subtitle">조합원 전용 설문조사 결과</p>
            
            <input 
                type="password" 
                class="password-input" 
                id="passwordInput" 
                placeholder="비밀번호를 입력하세요"
                maxlength="20"
            >
            
            <button class="password-button" onclick="checkPassword()">
                입장하기
            </button>
            
            <div class="password-error" id="passwordError">
                올바른 비밀번호를 입력해주세요.
            </div>
        </div>
    </div>

    <!-- 메인 콘텐츠 -->
    <div class="main-content" id="mainContent">
        <div class="container">
            <!-- 헤더 -->
            <header class="header">
                <div class="logo"></div>
                <h1 class="title">또바기 어린이집 조합원 설문조사</h1>
                <p class="subtitle">2025년 상반기 분석 결과</p>
            </header>

            <!-- 상단 통계 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">👥</div>
                    <div class="stat-value" id="respondentCount">35명</div>
                    <div class="stat-label">조합원 응답자</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">⭐</div>
                    <div class="stat-value" id="satisfactionScore">6.6/10</div>
                    <div class="stat-label">전반적 만족도</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">👩‍🏫</div>
                    <div class="stat-value" id="teacherScore">7.1/10</div>
                    <div class="stat-label">교사회 만족도</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">👨‍👩‍👧‍👦</div>
                    <div class="stat-value" id="relationScore">6.3/10</div>
                    <div class="stat-label">조합원 관계 만족도</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">🏛️</div>
                    <div class="stat-value" id="managementScore">7.5/10</div>
                    <div class="stat-label">운영위 만족도</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">🪞</div>
                    <div class="stat-value" id="selfScore">5.8/10</div>
                    <div class="stat-label">조합원 자가평가</div>
                </div>
            </div>

            <!-- 설문 문항들 -->
            <div class="sections" id="sectionsContainer">
                <!-- 문항들이 JavaScript로 동적 생성됩니다 -->
            </div>


        </div>
    </div>

    <script>
        // 전역 변수
        let surveyData = null;
        let charts = {};

        // 비밀번호 확인 함수
        function checkPassword() {
            const input = document.getElementById('passwordInput');
            const error = document.getElementById('passwordError');
            const passwordScreen = document.getElementById('passwordScreen');
            const mainContent = document.getElementById('mainContent');
            
            const correctPassword = 'ddobagi2025';
            
            if (input.value === correctPassword) {
                passwordScreen.classList.add('hidden');
                mainContent.classList.add('unlocked');
                error.style.display = 'none';
                
                sessionStorage.setItem('ddobagi_authenticated', 'true');
                loadSurveyData();
            } else {
                error.style.display = 'block';
                input.value = '';
                input.focus();
                
                input.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    input.style.animation = '';
                }, 500);
            }
        }
        
        // 엔터키로 비밀번호 입력
        document.getElementById('passwordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });
        
        // 페이지 로드 시 인증 상태 확인
        document.addEventListener('DOMContentLoaded', function() {
            const isAuthenticated = sessionStorage.getItem('ddobagi_authenticated');
            
            if (isAuthenticated === 'true') {
                document.getElementById('passwordScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.add('unlocked');
                loadSurveyData();
            } else {
                setTimeout(() => {
                    document.getElementById('passwordInput').focus();
                }, 100);
            }
        });

        // 실제 설문조사 데이터 로드
        async function loadSurveyData() {
            const isAuthenticated = sessionStorage.getItem('ddobagi_authenticated');
            if (isAuthenticated !== 'true') {
                console.log('인증되지 않은 접근');
                return;
            }
            
            try {
                // JSON 파일에서 데이터 로드
                const response = await fetch('/data/survey.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                surveyData = await response.json();
                console.log('JSON 파일에서 설문조사 데이터 로드 완료');
                initializeDashboard();
            } catch (error) {
                console.error('설문조사 데이터 로드 실패:', error);
                showError('설문조사 데이터를 불러오는데 실패했습니다. JSON 파일을 확인해주세요.');
            }
        }

        // 대시보드 초기화
        function initializeDashboard() {
            if (!surveyData) return;
            
            updateStats();
            createSections();
            
            console.log('대시보드 초기화 완료');
        }

        // 상단 통계 업데이트
        function updateStats() {
            const respondentCount = document.getElementById('respondentCount');
            const satisfactionScore = document.getElementById('satisfactionScore');
            const teacherScore = document.getElementById('teacherScore');
            const relationScore = document.getElementById('relationScore');
            const managementScore = document.getElementById('managementScore');
            const selfScore = document.getElementById('selfScore');
            
            if (surveyData.meta) {
                respondentCount.textContent = `${surveyData.meta.respondentCount || 35}명`;
                satisfactionScore.textContent = `${surveyData.meta.satisfactionScore || 6.6}/10`;
            }
            
            // 각 문항의 점수를 가져와서 업데이트
            const questions = surveyData.questions || [];
            questions.forEach(question => {
                if (question.id === 3 && teacherScore) {
                    teacherScore.textContent = `${question.score}/10`;
                }
                if (question.id === 4 && relationScore) {
                    relationScore.textContent = `${question.score}/10`;
                }
                if (question.id === 5 && managementScore) {
                    managementScore.textContent = `${question.score}/10`;
                }
                if (question.id === 6 && selfScore) {
                    selfScore.textContent = `${question.score}/10`;
                }
            });
        }

        // 설문 섹션들 생성
        function createSections() {
            const container = document.getElementById('sectionsContainer');
            const questions = surveyData.questions || [];
            
            container.innerHTML = '';
            
            questions.forEach((question, index) => {
                const sectionElement = createSectionElement(question, index + 1);
                container.appendChild(sectionElement);
            });
        }

        // 섹션 요소 생성
        function createSectionElement(question, questionNumber) {
            const section = document.createElement('div');
            section.className = 'section-card';
            section.innerHTML = `
                <div class="section-header" onclick="toggleSection('question${questionNumber}')">
                    <div class="section-title-area">
                        <div class="section-icon">${getQuestionIcon(question.type)}</div>
                        <div>
                            <div class="section-number">설문 문항 ${questionNumber}</div>
                            <div class="section-title">${question.title}</div>
                        </div>
                    </div>
                    <div class="chevron" id="chevron${questionNumber}">⌄</div>
                </div>
                <div class="section-content" id="content${questionNumber}">
                    ${createQuestionContent(question, questionNumber)}
                </div>
            `;
            
            return section;
        }

        // 질문 타입별 아이콘 반환
        function getQuestionIcon(type) {
            const icons = {
                'choice': '📊',
                'satisfaction': '⭐',
                'narrative': '💬',
                'combined': '📊'
            };
            return icons[type] || '📊';
        }

        // 질문 내용 생성
        function createQuestionContent(question, questionNumber) {
            console.log(`문항 ${questionNumber} 데이터:`, question);
            
            switch (question.type) {
                case 'choice':
                    return createChartContent(question, questionNumber);
                case 'satisfaction':
                    return createSatisfactionContent(question);
                case 'narrative':
                    return createNarrativeContent(question);
                case 'combined':
                    return createCombinedContent(question, questionNumber);
                default:
                    return '<div class="coming-soon"><h4>준비 중입니다</h4><p>해당 설문 문항의 데이터를 준비 중입니다.</p></div>';
            }
        }

        // 막대그래프 차트 콘텐츠 생성 (문항 1, 2, 8, 9)
        function createChartContent(question, questionNumber) {
            let improvementSection = '';
            
            // 문항 2번의 경우 긍정/개선 의견 처리 - 랜덤으로 섞기
            if (questionNumber === 2 && (question.data.positive_comments || question.data.negative_comments)) {
                let allComments = [];
                if (question.data.positive_comments) {
                    allComments = allComments.concat(question.data.positive_comments);
                }
                if (question.data.negative_comments) {
                    allComments = allComments.concat(question.data.negative_comments);
                }
                
                // 랜덤으로 섞기
                for (let i = allComments.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [allComments[i], allComments[j]] = [allComments[j], allComments[i]];
                }
                
                improvementSection += `
                    <div class="narrative-content" style="margin-top: 2rem;">
                        <div class="narrative-section">
                            ${allComments.map(response => `
                                <div class="quote-card">
                                    <p class="quote-text">${response}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // 문항 8, 9번의 경우 "추가 의견"으로 표기
            if (question.improvements) {
                const titleText = (questionNumber === 8 || questionNumber === 9) ? "💭 추가 의견" : "💬 기타 의견";
                improvementSection += `
                    <div class="narrative-section" style="margin-top: 2rem;">
                        <h4 class="narrative-title">${titleText}</h4>
                        ${question.improvements.map(response => `
                            <div class="quote-card">
                                <p class="quote-text">${response}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // JSON에서 responses 배열이 있는 경우 처리
            if (question.data.responses) {
                const titleText = (questionNumber === 8 || questionNumber === 9) ? "💭 추가 의견" : "💬 기타 의견";
                improvementSection += `
                    <div class="narrative-section" style="margin-top: 2rem;">
                        <h4 class="narrative-title">${titleText}</h4>
                        ${question.data.responses.map(response => `
                            <div class="quote-card">
                                <p class="quote-text">${response}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            return `
                <div class="chart-container">
                    <div class="chart-wrapper">
                        <canvas id="chart${questionNumber}"></canvas>
                    </div>
                    ${improvementSection}
                </div>
            `;
        }

        // 통합 콘텐츠 생성 (문항 2: 차트 + 서술형을 세로로 배치)
        function createCombinedContent(question, questionNumber) {
            // 긍정/부정 의견을 랜덤으로 섞기
            let allComments = [];
            if (question.data.positive_comments) {
                allComments = allComments.concat(question.data.positive_comments);
            }
            if (question.data.negative_comments) {
                allComments = allComments.concat(question.data.negative_comments);
            }
            
            // 랜덤으로 섞기
            for (let i = allComments.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allComments[i], allComments[j]] = [allComments[j], allComments[i]];
            }
            
            return `
                <div class="combined-section">
                    <div class="chart-container">
                        <div class="chart-wrapper">
                            <canvas id="chart${questionNumber}"></canvas>
                        </div>
                    </div>
                    <div class="narrative-content">
                        ${allComments.length > 0 ? `
                            <div class="narrative-section">
                                ${allComments.map(response => `
                                    <div class="quote-card">
                                        <p class="quote-text">${response}</p>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // 만족도 점수 표시 (텍스트만, 그래프 없음)
        function createSatisfactionContent(question) {
            // 긍정/부정 의견을 랜덤으로 섞기
            let allComments = [];
            if (question.data.positive_comments) {
                allComments = allComments.concat(question.data.positive_comments);
            }
            if (question.data.negative_comments) {
                allComments = allComments.concat(question.data.negative_comments);
            }
            
            // 랜덤으로 섞기
            for (let i = allComments.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allComments[i], allComments[j]] = [allComments[j], allComments[i]];
            }
            
            return `
                <div style="display: grid; grid-template-columns: 1fr; gap: 2rem;">
                    <div style="text-align: center; padding: 2rem; background: rgba(255,255,255,0.5); border-radius: 12px;">
                        <div style="font-size: 3rem; font-weight: bold; color: white; margin-bottom: 0.5rem;">${question.score}/10</div>
                        <div style="color: rgba(255,255,255,0.8); font-weight: bold;">평균 만족도</div>
                    </div>
                    <div class="narrative-content">
                        ${allComments.length > 0 ? `
                            <div class="narrative-section">
                                ${allComments.map(response => `
                                    <div class="quote-card">
                                        <p class="quote-text">${response}</p>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        ${question.data.responses && !question.data.positive_comments && !question.data.negative_comments ? `
                            <div class="narrative-section">
                                <h4 class="narrative-title">💬 기타 의견</h4>
                                ${question.data.responses.map(response => `
                                    <div class="quote-card">
                                        <p class="quote-text">${response.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}</p>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // 서술형 콘텐츠 생성
        function createNarrativeContent(question) {
            let content = '';
            
            // positive와 improvement 의견을 랜덤으로 섞기
            let allComments = [];
            if (question.data.positive) {
                allComments = allComments.concat(question.data.positive);
            }
            if (question.data.improvement) {
                allComments = allComments.concat(question.data.improvement);
            }
            
            // 랜덤으로 섞기
            for (let i = allComments.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allComments[i], allComments[j]] = [allComments[j], allComments[i]];
            }
            
            if (allComments.length > 0) {
                content += `
                    <div class="narrative-section">
                        ${allComments.map(response => `
                            <div class="quote-card">
                                <p class="quote-text">${response}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            if (question.data.responses && !question.data.positive && !question.data.improvement) {
                content = `
                    <div class="narrative-section">
                        <h4 class="narrative-title">💬 응답 내용</h4>
                        ${question.data.responses.map(response => `
                            <div class="quote-card">
                                <p class="quote-text">${response}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            return `<div class="narrative-grid">${content}</div>`;
        }



        // 섹션 토글 기능
        function toggleSection(sectionId) {
            const questionNumber = sectionId.replace('question', '');
            const content = document.getElementById(`content${questionNumber}`);
            const chevron = document.getElementById(`chevron${questionNumber}`);
            
            if (!content || !chevron) return;
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                chevron.classList.remove('rotated');
            } else {
                content.classList.add('active');
                chevron.classList.add('rotated');
                
                // 차트가 있는 섹션이면 차트 그리기
                if (questionNumber && !isNaN(questionNumber)) {
                    const question = surveyData.questions[parseInt(questionNumber) - 1];
                    if (question && (question.type === 'choice' || question.type === 'combined')) {
                        setTimeout(() => createChart(parseInt(questionNumber)), 100);
                    }
                }
            }
        }

        // 가로형 막대그래프 차트 생성
        function createChart(questionNumber) {
            const question = surveyData.questions[questionNumber - 1];
            if (!question || charts[`chart${questionNumber}`]) return;
            
            let chartData;
            if (question.type === 'combined') {
                // combined 타입의 경우 data.choices를 사용
                if (question.data && question.data.choices) {
                    chartData = question.data.choices.map(item => ({
                        reason: item.reason,
                        percentage: item.percentage
                    }));
                } else {
                    console.log('Combined 타입 차트 데이터가 없습니다:', question);
                    return;
                }
            } else if (question.type === 'choice') {
                // choice 타입의 경우 data.choices를 사용
                if (question.data && question.data.choices) {
                    chartData = question.data.choices.map(item => ({
                        reason: item.reason,
                        percentage: item.percentage
                    }));
                } else if (question.data && Array.isArray(question.data)) {
                    // 기존 배열 형태도 지원
                    chartData = question.data;
                } else {
                    console.log('Choice 타입 차트 데이터가 없습니다:', question);
                    return;
                }
            } else {
                return;
            }
            
            const ctx = document.getElementById(`chart${questionNumber}`);
            if (!ctx) return;
            
            console.log(`문항 ${questionNumber} 차트 데이터:`, chartData);
            
            // 가로형 막대그래프 설정
            const chartConfig = {
                type: 'bar',
                data: {
                    labels: chartData.map(item => item.reason),
                    datasets: [{
                        data: chartData.map(item => item.percentage),
                        backgroundColor: 'rgba(70, 130, 180, 0.8)',
                        borderColor: 'rgba(70, 130, 180, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y', // 가로형 막대그래프로 설정
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    return chartData[index].reason;
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const item = chartData[index];
                                    const count = item.count || Math.round(item.percentage * 35 / 100);
                                    return `${count}명 (${item.percentage}%)`;
                                }
                            }
                        },
                        // 차트 외부에 라벨 표시
                        datalabels: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { 
                                color: 'white',
                                font: {
                                    weight: 'bold'
                                },
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: { 
                                color: 'rgba(255, 255, 255, 0.2)',
                                display: true
                            }
                        },
                        y: {
                            ticks: { 
                                color: 'white',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                },
                                callback: function(value, index) {
                                    const item = chartData[index];
                                    const count = item.count || Math.round(item.percentage * 35 / 100);
                                    return `${item.reason} (${count}명, ${item.percentage}%)`;
                                }
                            },
                            grid: { 
                                color: 'rgba(255, 255, 255, 0.1)',
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            };
            
            charts[`chart${questionNumber}`] = new Chart(ctx, chartConfig);
        }

        // 에러 표시
        function showError(message) {
            const container = document.getElementById('sectionsContainer');
            container.innerHTML = `
                <div class="section-card">
                    <div style="padding: 3rem; text-align: center; color: rgba(255,255,255,0.8);">
                        <h3 style="margin-bottom: 1rem;">⚠️ 오류 발생</h3>
                        <p>${message}</p>
                        <p style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.7;">
                            브라우저 콘솔을 확인해보세요.
                        </p>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>