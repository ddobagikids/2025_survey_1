<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>또바기 어린이집 조합원 설문조사</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 기본 스타일 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #5fa031 0%, #4a7c23 100%);
            min-height: 100vh;
            color: white;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        /* 비밀번호 입력 화면 */
        .password-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #5fa031 0%, #4a7c23 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .password-container {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
        }
        
        .password-logo {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 2rem;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            background-image: url('/assets/logo.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* 로고 이미지가 없을 때 또 글자 숨김 */
        .password-logo:empty {
            /* 글자 표시 안함 */
        }
        
        .password-title {
            color: white;
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .password-subtitle {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 2rem;
            font-size: 1rem;
        }
        
        .password-input,
        .password-button {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            box-sizing: border-box;
        }
        
        .password-input {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .password-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .password-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
        }
        
        .password-button {
            background: rgba(255, 255, 255, 0.9);
            color: #4a7c23;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .password-button:hover {
            background: white;
            transform: translateY(-2px);
        }
        
        .password-error {
            color: #fca5a5;
            margin-top: 1rem;
            font-size: 0.9rem;
            display: none;
        }
        
        .main-content {
            display: none;
        }
        
        .main-content.unlocked {
            display: block;
        }
        
        .password-screen.hidden {
            display: none;
        }

        /* 헤더 */
        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 2rem;
            font-size: 2rem;
            font-weight: bold;
            background-image: url('/assets/logo.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* 로고 이미지가 없을 때 또 글자 숨김 */
        .logo:empty {
            /* 글자 표시 안함 */
        }

        .title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 2rem;
        }

        /* 통계 카드 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 3rem;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            opacity: 0.8;
            font-size: 0.9rem;
        }

        /* 섹션 카드 */
        .section-card {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .section-card:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 2rem;
            cursor: pointer;
        }

        .section-title-area {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .section-icon {
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
        }

        .section-number {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 0.25rem;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .section-content {
            padding: 0 2rem 2rem;
            display: none;
        }

        .section-content.active {
            display: block;
        }

        .chevron {
            font-size: 1.5rem;
            transition: transform 0.3s ease;
        }

        .chevron.rotated {
            transform: rotate(180deg);
        }

        /* 차트 컨테이너 */
        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .chart-wrapper {
            position: relative;
            height: 500px;
            margin-bottom: 1rem;
        }

        /* 만족도 점수 표시 */
        .satisfaction-score {
            text-align: center;
            padding: 3rem 2rem;
        }

        .score-display {
            font-size: 4rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #fff;
        }

        .score-label {
            font-size: 1.2rem;
            opacity: 0.8;
            margin-bottom: 2rem;
        }

        /* 서술형 응답 */
        .narrative-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .narrative-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 2rem;
        }

        .narrative-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quote-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: background 0.2s ease;
        }

        .quote-card:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .quote-text {
            font-style: italic;
            line-height: 1.6;
            opacity: 0.9;
        }

        .quote-text:before {
            content: '"';
            font-size: 1.2em;
            color: rgba(255, 255, 255, 0.6);
        }

        .quote-text:after {
            content: '"';
            font-size: 1.2em;
            color: rgba(255, 255, 255, 0.6);
        }

        /* 종합 요약 */
        .summary-section {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-top: 3rem;
        }

        .summary-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .summary-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 2rem;
        }

        .summary-card h4 {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .summary-list {
            list-style: none;
        }

        .summary-list li {
            margin-bottom: 0.8rem;
            padding-left: 1rem;
            position: relative;
            opacity: 0.9;
            line-height: 1.5;
        }

        .summary-list li::before {
            content: '•';
            position: absolute;
            left: 0;
            color: white;
            font-weight: bold;
        }

        /* 통합 섹션 스타일 */
        .combined-section {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .chart-and-narrative {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .stat-card {
                padding: 1.5rem;
            }
            
            .stat-value {
                font-size: 2rem;
            }
            
            .section-header {
                padding: 1.5rem;
            }
            
            .section-title {
                font-size: 1.1rem;
            }
            
            .chart-wrapper {
                height: 400px;
            }
            
            .narrative-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-and-narrative {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0.5rem;
            }
            
            .title {
                font-size: 1.5rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .stat-card {
                padding: 1rem;
            }
            
            .stat-value {
                font-size: 1.8rem;
            }
            
            .stat-icon {
                font-size: 2rem;
                margin-bottom: 0.5rem;
            }
            
            .section-header {
                padding: 1rem;
            }
            
            .section-content {
                padding: 0 1rem 1rem;
            }
            
            .chart-wrapper {
                height: 350px;
            }

            .score-display {
                font-size: 3rem;
            }
        }

        /* 플로팅 네비게이션 */
        .floating-nav {
            position: fixed;
            right: 2rem;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
            min-width: 200px;
        }

        .floating-nav h4 {
            color: white;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            text-align: center;
            opacity: 0.9;
        }

        .nav-item {
            display: block;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.25rem;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        /* 모바일에서 플로팅 네비게이션 숨김 */
        @media (max-width: 768px) {
            .floating-nav {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- 비밀번호 입력 화면 -->
    <div class="password-screen" id="passwordScreen">
        <div class="password-container">
            <div class="password-logo"></div>
            <h1 class="password-title">또바기 어린이집</h1>
            <p class="password-subtitle">조합원 전용 설문조사 결과</p>
            
            <input 
                type="password" 
                class="password-input" 
                id="passwordInput" 
                placeholder="비밀번호를 입력하세요"
                maxlength="20"
            >
            
            <button class="password-button" onclick="checkPassword()">
                입장하기
            </button>
            
            <div class="password-error" id="passwordError">
                올바른 비밀번호를 입력해주세요.
            </div>
        </div>
    </div>

    <!-- 메인 콘텐츠 -->
    <div class="main-content" id="mainContent">
        <div class="container">
            <!-- 헤더 -->
            <header class="header">
                <div class="logo"></div>
                <h1 class="title">또바기 어린이집 조합원 설문조사</h1>
                <p class="subtitle">2025년 상반기 분석 결과</p>
            </header>

            <!-- 상단 통계 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">👥</div>
                    <div class="stat-value" id="respondentCount">35명</div>
                    <div class="stat-label">조합원 응답자</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">⭐</div>
                    <div class="stat-value" id="satisfactionScore">6.6/10</div>
                    <div class="stat-label">전반적 만족도</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">👩‍🏫</div>
                    <div class="stat-value" id="teacherScore">7.1/10</div>
                    <div class="stat-label">교사회 만족도</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">👨‍👩‍👧‍👦</div>
                    <div class="stat-value" id="relationScore">6.3/10</div>
                    <div class="stat-label">조합원 관계 만족도</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">🏛️</div>
                    <div class="stat-value" id="managementScore">7.5/10</div>
                    <div class="stat-label">운영위 만족도</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">🪞</div>
                    <div class="stat-value" id="selfScore">5.8/10</div>
                    <div class="stat-label">조합원 자가평가</div>
                </div>
            </div>

            <!-- 설문 문항들 -->
            <div class="sections" id="sectionsContainer">
                <!-- 문항들이 JavaScript로 동적 생성됩니다 -->
            </div>

            <!-- 종합 요약 -->
            <div class="summary-section">
                <h3 class="summary-title">
                    <span>📄</span>
                    종합 요약
                </h3>
                
                <div class="summary-grid" id="summaryContent">
                    <!-- 요약 내용이 JavaScript로 동적 생성됩니다 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let surveyData = null;
        let charts = {};

        // 비밀번호 확인 함수
        function checkPassword() {
            const input = document.getElementById('passwordInput');
            const error = document.getElementById('passwordError');
            const passwordScreen = document.getElementById('passwordScreen');
            const mainContent = document.getElementById('mainContent');
            
            const correctPassword = 'ddobagi2025';
            
            if (input.value === correctPassword) {
                passwordScreen.classList.add('hidden');
                mainContent.classList.add('unlocked');
                error.style.display = 'none';
                
                sessionStorage.setItem('ddobagi_authenticated', 'true');
                loadSurveyData();
            } else {
                error.style.display = 'block';
                input.value = '';
                input.focus();
                
                input.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    input.style.animation = '';
                }, 500);
            }
        }
        
        // 엔터키로 비밀번호 입력
        document.getElementById('passwordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });
        
        // 페이지 로드 시 인증 상태 확인
        document.addEventListener('DOMContentLoaded', function() {
            const isAuthenticated = sessionStorage.getItem('ddobagi_authenticated');
            
            if (isAuthenticated === 'true') {
                document.getElementById('passwordScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.add('unlocked');
                loadSurveyData();
            } else {
                setTimeout(() => {
                    document.getElementById('passwordInput').focus();
                }, 100);
            }
        });

        // 실제 설문조사 데이터 로드
        async function loadSurveyData() {
            const isAuthenticated = sessionStorage.getItem('ddobagi_authenticated');
            if (isAuthenticated !== 'true') {
                console.log('인증되지 않은 접근');
                return;
            }
            
            try {
                // JSON 파일에서 데이터 로드
                const response = await fetch('/data/survey.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                surveyData = await response.json();
                console.log('JSON 파일에서 설문조사 데이터 로드 완료');
                initializeDashboard();
            } catch (error) {
                console.error('설문조사 데이터 로드 실패:', error);
                showError('설문조사 데이터를 불러오는데 실패했습니다. JSON 파일을 확인해주세요.');
            }
        }

        // 대시보드 초기화
        function initializeDashboard() {
            if (!surveyData) return;
            
            updateStats();
            createSections();
            createSummary();
            
            console.log('대시보드 초기화 완료');
        }

        // 상단 통계 업데이트
        function updateStats() {
            const respondentCount = document.getElementById('respondentCount');
            const satisfactionScore = document.getElementById('satisfactionScore');
            const teacherScore = document.getElementById('teacherScore');
            const relationScore = document.getElementById('relationScore');
            const managementScore = document.getElementById('managementScore');
            const selfScore = document.getElementById('selfScore');
            
            if (surveyData.meta) {
                respondentCount.textContent = `${surveyData.meta.respondentCount || 35}명`;
                satisfactionScore.textContent = `${surveyData.meta.satisfactionScore || 6.6}/10`;
            }
            
            // 각 문항의 점수를 가져와서 업데이트
            const questions = surveyData.questions || [];
            questions.forEach(question => {
                if (question.id === 3 && teacherScore) {
                    teacherScore.textContent = `${question.score}/10`;
                }
                if (question.id === 4 && relationScore) {
                    relationScore.textContent = `${question.score}/10`;
                }
                if (question.id === 5 && managementScore) {
                    managementScore.textContent = `${question.score}/10`;
                }
                if (question.id === 6 && selfScore) {
                    selfScore.textContent = `${question.score}/10`;
                }
            });
        }

        // 설문 섹션들 생성
        function createSections() {
            const container = document.getElementById('sectionsContainer');
            const questions = surveyData.questions || [];
            
            container.innerHTML = '';
            
            questions.forEach((question, index) => {
                const sectionElement = createSectionElement(question, index + 1);
                container.appendChild(sectionElement);
            });
        }

        // 섹션 요소 생성
        function createSectionElement(question, questionNumber) {
            const section = document.createElement('div');
            section.className = 'section-card';
            section.innerHTML = `
                <div class="section-header" onclick="toggleSection('question${questionNumber}')">
                    <div class="section-title-area">
                        <div class="section-icon">${getQuestionIcon(question.type)}</div>
                        <div>
                            <div class="section-number">설문 문항 ${questionNumber}</div>
                            <div class="section-title">${question.title}</div>
                        </div>
                    </div>
                    <div class="chevron" id="chevron${questionNumber}">⌄</div>
                </div>
                <div class="section-content" id="content${questionNumber}">
                    ${createQuestionContent(question, questionNumber)}
                </div>
            `;
            
            return section;
        }

        // 질문 타입별 아이콘 반환
        function getQuestionIcon(type) {
            const icons = {
                'choice': '📊',
                'satisfaction': '⭐',
                'narrative': '💬',
                'combined': '📊'
            };
            return icons[type] || '📊';
        }

        // 질문 내용 생성
        function createQuestionContent(question, questionNumber) {
            console.log(`문항 ${questionNumber} 데이터:`, question);
            
            switch (question.type) {
                case 'choice':
                    return createChartContent(question, questionNumber);
                case 'satisfaction':
                    return createSatisfactionContent(question);
                case 'narrative':
                    return createNarrativeContent(question);
                case 'combined':
                    return createCombinedContent(question, questionNumber);
                default:
                    return '<div class="coming-soon"><h4>준비 중입니다</h4><p>해당 설문 문항의 데이터를 준비 중입니다.</p></div>';
            }
        }

        // 막대그래프 차트 콘텐츠 생성 (문항 1, 2, 8, 9)
        function createChartContent(question, questionNumber) {
            let improvementSection = '';
            
            // 문항 2번의 경우 긍정/개선 의견 처리
            if (questionNumber === 2 && question.data.positive_comments) {
                improvementSection += `
                    <div class="narrative-content" style="margin-top: 2rem;">
                        <div class="narrative-section">
                            <h4 class="narrative-title">👍 긍정적 의견</h4>
                            ${question.data.positive_comments.map(response => `
                                <div class="quote-card">
                                    <p class="quote-text">${response}</p>
                                </div>
                            `).join('')}
                        </div>
                        ${question.data.negative_comments ? `
                            <div class="narrative-section" style="margin-top: 2rem;">
                                <h4 class="narrative-title">⚠️ 개선이 필요한 점</h4>
                                ${question.data.negative_comments.map(response => `
                                    <div class="quote-card">
                                        <p class="quote-text">${response}</p>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // 문항 8, 9번의 경우 "추가 의견"으로 표기
            if (question.improvements) {
                const titleText = (questionNumber === 8 || questionNumber === 9) ? "💭 추가 의견" : "⚠️ 개선이 필요한 점";
                improvementSection += `
                    <div class="narrative-section" style="margin-top: 2rem;">
                        <h4 class="narrative-title">${titleText}</h4>
                        ${question.improvements.map(response => `
                            <div class="quote-card">
                                <p class="quote-text">${response}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // JSON에서 responses 배열이 있는 경우 처리
            if (question.data.responses) {
                const titleText = (questionNumber === 8 || questionNumber === 9) ? "💭 추가 의견" : "💬 기타 의견";
                improvementSection += `
                    <div class="narrative-section" style="margin-top: 2rem;">
                        <h4 class="narrative-title">${titleText}</h4>
                        ${question.data.responses.map(response => `
                            <div class="quote-card">
                                <p class="quote-text">${response}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            return `
                <div class="chart-container">
                    <div class="chart-wrapper">
                        <canvas id="chart${questionNumber}"></canvas>
                    </div>
                    ${improvementSection}
                </div>
            `;
        }

        // 통합 콘텐츠 생성 (문항 2: 차트 + 서술형을 세로로 배치)
        function createCombinedContent(question, questionNumber) {
            return `
                <div class="combined-section">
                    <div class="chart-container">
                        <div class="chart-wrapper">
                            <canvas id="chart${questionNumber}"></canvas>
                        </div>
                    </div>
                    <div class="narrative-content">
                        ${question.data.positive_comments ? `
                            <div class="narrative-section">
                                <h4 class="narrative-title">👍 긍정적 의견</h4>
                                ${question.data.positive_comments.map(response => `
                                    <div class="quote-card">
                                        <p class="quote-text">${response}</p>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        ${question.data.negative_comments ? `
                            <div class="narrative-section" style="margin-top: 2rem;">
                                <h4 class="narrative-title">⚠️ 개선이 필요한 점</h4>
                                ${question.data.negative_comments.map(response => `
                                    <div class="quote-card">
                                        <p class="quote-text">${response}</p>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // 만족도 점수 표시 (텍스트만, 그래프 없음)
        function createSatisfactionContent(question) {
            return `
                <div style="display: grid; grid-template-columns: 1fr; gap: 2rem;">
                    <div style="text-align: center; padding: 2rem; background: rgba(255,255,255,0.1); border-radius: 12px;">
                        <div style="font-size: 3rem; font-weight: bold; color: white; margin-bottom: 0.5rem;">${question.score}/10</div>
                        <div style="color: rgba(255,255,255,0.8);">평균 만족도</div>
                    </div>
                    <div class="narrative-content">
                        ${question.data.positive_comments ? `
                            <div class="narrative-section">
                                <h4 class="narrative-title">👍 긍정적 의견</h4>
                                ${question.data.positive_comments.map(response => `
                                    <div class="quote-card">
                                        <p class="quote-text">${response}</p>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        ${question.data.negative_comments ? `
                            <div class="narrative-section" style="margin-top: 2rem;">
                                <h4 class="narrative-title">⚠️ 개선이 필요한 점</h4>
                                ${question.data.negative_comments.map(response => `
                                    <div class="quote-card">
                                        <p class="quote-text">${response}</p>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        ${question.data.responses && !question.data.positive_comments && !question.data.negative_comments ? `
                            <div class="narrative-section">
                                <h4 class="narrative-title">💬 기타 의견</h4>
                                ${question.data.responses.map(response => `
                                    <div class="quote-card">
                                        <p class="quote-text">${response}</p>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // 서술형 콘텐츠 생성
        function createNarrativeContent(question) {
            let content = '';
            
            if (question.data.positive) {
                content += `
                    <div class="narrative-section">
                        <h4 class="narrative-title">👍 긍정적 의견</h4>
                        ${question.data.positive.map(response => `
                            <div class="quote-card">
                                <p class="quote-text">${response}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            if (question.data.improvement) {
                content += `
                    <div class="narrative-section">
                        <h4 class="narrative-title">⚠️ 개선이 필요한 점</h4>
                        ${question.data.improvement.map(response => `
                            <div class="quote-card">
                                <p class="quote-text">${response}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            if (question.data.responses) {
                content = `
                    <div class="narrative-section">
                        <h4 class="narrative-title">💬 응답 내용</h4>
                        ${question.data.responses.map(response => `
                            <div class="quote-card">
                                <p class="quote-text">${response}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            return `<div class="narrative-grid">${content}</div>`;
        }

        // 종합 요약 생성
        function createSummary() {
            const container = document.getElementById('summaryContent');
            
            container.innerHTML = `
                <div class="summary-card">
                    <h4>🌟 또바기의 핵심 강점은?</h4>
                    <ul class="summary-list">
                        <li><strong>압도적인 야외활동 만족도</strong> - 공동육아 선택 이유 1위(85.7%), 가장 좋은 점 1위(91.4%)로 나들이와 야외활동이 최고의 강점</li>
                        <li><strong>교사 대 아동 비율의 우수성</strong> - 선택 이유 2위(48.6%), 좋은 점 2위(62.9%)로 꾸준히 높은 평가를 받는 핵심 경쟁력</li>
                        <li><strong>자연 친화적 교육과정</strong> - 자연활동(57.1%), 세시절기(34.3%), 숲나들이(54.3%) 등 계절과 자연을 느끼는 교육에 대한 높은 만족</li>
                        <li><strong>진정성 있는 교사들</strong> - "아이들과 진심으로 놀아주는 모습", "편견 없이 동일한 애정으로 대하는 프로페셔널함" 등 교사의 진정성 인정</li>
                        <li><strong>마실 문화를 통한 부모 네트워크</strong> - 또래 부모들과의 자연스러운 만남과 교류로 육아가 덜 외롭다는 긍정적 평가</li>
                        <li><strong>인지교육 없는 자유로운 놀이 중심</strong> - "초등 전에 뛰어놀게 하고 싶다", "그냥 놀게 내버려두자" 등 자유놀이에 대한 철학 공유</li>
                        <li><strong>아이 개별 존중과 세심한 보육</strong> - "한 명 한 명을 인격체로 존중", "아이들 의견 충분히 존중" 등 개별 맞춤 보육 인정</li>
                        <li><strong>공동체를 통한 성장 경험</strong> - "어른도 함께 자라날 수 있는 곳", "다양한 관계 속에서 시야가 넓어짐" 등 공동체 가치 실현</li>
                        <li><strong>전통문화와 다양한 체험활동</strong> - 축구교실(28.6%), 성곽걷기(28.6%), 택견(20%) 등 다채로운 프로그램 운영</li>
                        <li><strong>운영위원회의 헌신적 노력</strong> - "발로 뛰며 직접 행동", "진심을 다하는 모습" 등에 대해 평균 7.51점의 높은 만족도</li>
                    </ul>
                </div>
                <div class="summary-card">
                    <h4>📝 우리에게 남은 숙제는?</h4>
                    <ul class="summary-list">
                        <li><strong>갈등 중재 시스템 구축 시급</strong> - 80%가 가장 시급한 개선사항으로 선택, "제대로 중재해줄 사람도 시스템도 없어 힘들다"는 호소 다수</li>
                        <li><strong>조합원 간 관계 개선 필요</strong> - 57.1%가 가장 어려운 점으로 꼽으며, "기존·소수의 또바기 같은 느낌", "왕따·배척·소외 존재" 등 심각한 문제 지적</li>
                        <li><strong>교사-가정 소통 강화 요구</strong> - 60%가 개선 필요 영역으로 선택, "건의사항 전달 창구 모호", "매끄럽게 해결되지 않는 문제들" 언급</li>
                        <li><strong>신입 온보딩 체계 미흡</strong> - 51.4%가 개선 필요, "기존 가정이 신입을 챙기지 않고 오히려 이해 강요", "적응하기 쉽지 않았음" 토로</li>
                        <li><strong>마실 문화의 본질 회복</strong> - "본래 의미를 많이 잃었다", "어른들이 즐기기 위한 문화가 아니었다"며 아이 중심으로의 전환 요구</li>
                        <li><strong>체계적인 갈등 해결 매뉴얼 부재</strong> - "매번 반복되는 갈등 상황에 명확한 기준 없이 흔들리기만 함", "가이드와 중재위 필요" 절실히 요구</li>
                        <li><strong>부모 교육과 공동육아 철학 공유 부족</strong> - 37.1%가 부모 교육 확대 필요성 제기, "공동육아에 대한 자의적 해석으로 갈등 발생"</li>
                        <li><strong>과도한 조합원 역할 부담</strong> - 아마일수 채우기(40%), 운영위원 수행(37.1%) 등이 어려운 점으로 꼽히며 "의무사항이 너무 많다" 불만</li>
                        <li><strong>아이들 예의범절 교육 강화</strong> - "인사하기, 경청하기, 대답하기 등 기본 생활규칙을 바로잡고 싶다"는 구체적 요구 다수</li>
                        <li><strong>전문성과 일관성 있는 교육 시스템</strong> - "보육교육 전문 커리큘럼 체계화", "공동육아 색깔을 나타낼 교육활동 연구 필요" 등 질적 향상 요구</li>
                    </ul>
                </div>
            `;
        }

        // 섹션 토글 기능
        function toggleSection(sectionId) {
            const questionNumber = sectionId.replace('question', '');
            const content = document.getElementById(`content${questionNumber}`);
            const chevron = document.getElementById(`chevron${questionNumber}`);
            
            if (!content || !chevron) return;
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                chevron.classList.remove('rotated');
            } else {
                content.classList.add('active');
                chevron.classList.add('rotated');
                
                // 차트가 있는 섹션이면 차트 그리기
                if (questionNumber && !isNaN(questionNumber)) {
                    const question = surveyData.questions[parseInt(questionNumber) - 1];
                    if (question && (question.type === 'choice' || question.type === 'combined')) {
                        setTimeout(() => createChart(parseInt(questionNumber)), 100);
                    }
                }
            }
        }

        // 가로형 막대그래프 차트 생성
        function createChart(questionNumber) {
            const question = surveyData.questions[questionNumber - 1];
            if (!question || charts[`chart${questionNumber}`]) return;
            
            let chartData;
            if (question.type === 'combined') {
                // combined 타입의 경우 data.choices를 사용
                if (question.data && question.data.choices) {
                    chartData = question.data.choices.map(item => ({
                        reason: item.reason,
                        percentage: item.percentage
                    }));
                } else {
                    console.log('Combined 타입 차트 데이터가 없습니다:', question);
                    return;
                }
            } else if (question.type === 'choice') {
                // choice 타입의 경우 data.choices를 사용
                if (question.data && question.data.choices) {
                    chartData = question.data.choices.map(item => ({
                        reason: item.reason,
                        percentage: item.percentage
                    }));
                } else if (question.data && Array.isArray(question.data)) {
                    // 기존 배열 형태도 지원
                    chartData = question.data;
                } else {
                    console.log('Choice 타입 차트 데이터가 없습니다:', question);
                    return;
                }
            } else {
                return;
            }
            
            const ctx = document.getElementById(`chart${questionNumber}`);
            if (!ctx) return;
            
            console.log(`문항 ${questionNumber} 차트 데이터:`, chartData);
            
            // 가로형 막대그래프 설정
            const chartConfig = {
                type: 'bar',
                data: {
                    labels: chartData.map(item => item.reason),
                    datasets: [{
                        data: chartData.map(item => item.percentage),
                        backgroundColor: 'rgba(70, 130, 180, 0.8)',
                        borderColor: 'rgba(70, 130, 180, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y', // 가로형 막대그래프로 설정
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    return chartData[index].reason;
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const item = chartData[index];
                                    const count = item.count || Math.round(item.percentage * 35 / 100);
                                    return `${count}명 (${item.percentage}%)`;
                                }
                            }
                        },
                        // 차트 외부에 라벨 표시
                        datalabels: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { 
                                color: 'white',
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: { 
                                color: 'rgba(255, 255, 255, 0.2)',
                                display: true
                            }
                        },
                        y: {
                            ticks: { 
                                color: 'white',
                                font: {
                                    size: 12
                                },
                                callback: function(value, index) {
                                    const item = chartData[index];
                                    const count = item.count || Math.round(item.percentage * 35 / 100);
                                    return `${item.reason} (${count}명, ${item.percentage}%)`;
                                }
                            },
                            grid: { 
                                color: 'rgba(255, 255, 255, 0.1)',
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            };
            
            charts[`chart${questionNumber}`] = new Chart(ctx, chartConfig);
        }

        // 에러 표시
        function showError(message) {
            const container = document.getElementById('sectionsContainer');
            container.innerHTML = `
                <div class="section-card">
                    <div style="padding: 3rem; text-align: center; color: rgba(255,255,255,0.8);">
                        <h3 style="margin-bottom: 1rem;">⚠️ 오류 발생</h3>
                        <p>${message}</p>
                        <p style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.7;">
                            브라우저 콘솔을 확인해보세요.
                        </p>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>